#!/bin/bash
# tsyne - TypeScript native GUI runner
#
# This is a thin wrapper that sets up the environment and delegates to the TypeScript CLI.
# All argument parsing, @grab handling, and app execution is done in TypeScript for
# cross-platform compatibility (works on Linux, macOS, Windows/Git Bash, WSL).
#
# Usage: tsyne [options] <app.ts>
#
# See: tsyne --help for full options

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TSYNE_SOURCE="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
NC='\033[0m'

log_error() {
    echo -e "${RED}[tsyne]${NC} $1"
}

# Check for Node.js
if ! command -v node &> /dev/null; then
    log_error "Node.js is required but not found. Please install Node.js first."
    exit 1
fi

# Find and set up bridge path
BRIDGE_PATH="$TSYNE_SOURCE/core/bin/tsyne-bridge"
if [ ! -f "$BRIDGE_PATH" ]; then
    log_error "tsyne-bridge not found at $BRIDGE_PATH"
    log_error "Run: pnpm run build:bridge"
    exit 1
fi
export TSYNE_BRIDGE_PATH="$BRIDGE_PATH"

# Check for stray bridge executables in wrong locations that could cause confusion during Tsyne's own development cycle
STRAY_BRIDGES=""
for stray_path in "$TSYNE_SOURCE/dist/bridge/bridge" "$TSYNE_SOURCE/cli/embed/runtime/tsyne/dist/bridge/bridge"; do
    if [ -f "$stray_path" ]; then
        STRAY_BRIDGES="$STRAY_BRIDGES\n  $stray_path"
    fi
done
if [ -n "$STRAY_BRIDGES" ]; then
    log_error "Found stray bridge executable(s) in wrong location(s):$STRAY_BRIDGES"
    log_error "These may be stale and cause issues. Remove them with:"
    log_error "  rm -f $TSYNE_SOURCE/dist/bridge/bridge $TSYNE_SOURCE/cli/embed/runtime/tsyne/dist/bridge/bridge"
    exit 1
fi

# Set up NODE_PATH so the app can find tsyne and cosyne
# Dev mode: use source directories directly
TSYNE_NODE_PATH="$TSYNE_SOURCE/core/dist/src"
COSYNE_NODE_PATH="$TSYNE_SOURCE/cosyne/dist"

# Build NODE_PATH: tsyne, cosyne, core's node_modules, monorepo node_modules, existing NODE_PATH
EFFECTIVE_NODE_PATH="$TSYNE_SOURCE:$TSYNE_SOURCE/core/node_modules:$TSYNE_SOURCE/node_modules"
if [ -n "$NODE_PATH" ]; then
    EFFECTIVE_NODE_PATH="$EFFECTIVE_NODE_PATH:$NODE_PATH"
fi

# Find the CLI entry point
CLI_PATH="$TSYNE_SOURCE/core/dist/src/cli.js"
if [ ! -f "$CLI_PATH" ]; then
    log_error "CLI not found at $CLI_PATH"
    log_error "Run: pnpm run build:core"
    exit 1
fi

# Run the TypeScript CLI with all arguments
NODE_PATH="$EFFECTIVE_NODE_PATH" node "$CLI_PATH" "$@"
